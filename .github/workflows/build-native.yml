name: build-native

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref/SHA to checkout"
        required: false
        type: string

permissions:
  contents: read

jobs:
  build_native:
    name: build-native (${{ matrix.platform }})
    runs-on: ${{ matrix.runs_on }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            runs_on: ubuntu-latest
            script: bash build-scripts/build-linux.sh
          - platform: windows
            runs_on: ubuntu-latest
            script: bash build-scripts/build-windows.sh
          - platform: darwin
            runs_on: macos-14
            script: |
              bash build-scripts/build-darwin.sh amd64
              bash build-scripts/build-darwin.sh arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref != '' && inputs.ref || github.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install build tools (Linux cross-compilation)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git gcc-aarch64-linux-gnu

      - name: Install build tools (Windows cross-compilation)
        if: matrix.platform == 'windows'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git mingw-w64

      - name: Build native library (Linux - amd64 + arm64)
        if: matrix.platform == 'linux'
        run: |
          ${{ matrix.script }} amd64
          ${{ matrix.script }} arm64

      - name: Build native library (Windows - amd64)
        if: matrix.platform == 'windows'
        run: |
          ${{ matrix.script }} amd64

      - name: Build native library
        if: matrix.platform == 'darwin'
        run: ${{ matrix.script }}

      - name: Verify native binaries are present (per platform)
        shell: bash
        run: |
          set -euo pipefail
          echo "Build outputs:"
          find build/out -maxdepth 2 -type f -print || true

          case "${{ matrix.platform }}" in
            linux)
              required=(
                "build/out/linux-amd64/libgitleaks.so"
                "build/out/linux-arm64/libgitleaks.so"
              )
              ;;
            windows)
              required=(
                "build/out/windows-amd64/libgitleaks.dll"
              )
              ;;
            darwin)
              required=(
                "build/out/darwin-amd64/libgitleaks.dylib"
                "build/out/darwin-arm64/libgitleaks.dylib"
              )
              ;;
            *)
              echo "Unknown platform: ${{ matrix.platform }}" >&2
              exit 1
              ;;
          esac

          missing=0
          for f in "${required[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing: $f" >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "Native binaries are missing for platform=${{ matrix.platform }}; failing workflow." >&2
            exit 1
          fi

      - name: Upload native artifacts (Darwin AMD64)
        if: matrix.platform == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: native-darwin-amd64
          path: build/out/darwin-amd64
          if-no-files-found: error
      
      - name: Upload native artifacts (Darwin ARM64)
        if: matrix.platform == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: native-darwin-arm64
          path: build/out/darwin-arm64
          if-no-files-found: error

      - name: Upload native artifacts (Linux AMD64)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-amd64
          path: build/out/linux-amd64
          if-no-files-found: error

      - name: Upload native artifacts (Linux ARM64)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-arm64
          path: build/out/linux-arm64
          if-no-files-found: error

      - name: Upload native artifacts (Windows AMD64)
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: native-windows-amd64
          path: build/out/windows-amd64
          if-no-files-found: error


