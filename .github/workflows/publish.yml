name: publish

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  actions: read
  contents: read

concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  gate_test:
    name: wait-for-test-workflow
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Wait for test workflow to succeed for this SHA
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const headSha = context.sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const sleepMs = 15_000;
            const maxAttempts = 120; // 30 minutes

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: "test.yml",
                head_sha: headSha,
                event: "push",
                per_page: 10,
              });

              const run = runs.data.workflow_runs && runs.data.workflow_runs[0];
              if (run) {
                core.info(`Found test workflow run: id=${run.id} status=${run.status} conclusion=${run.conclusion}`);
                if (run.status === "completed") {
                  if (run.conclusion === "success") {
                    core.info("test.yml succeeded; continuing publish workflow.");
                    return;
                  }
                  core.setFailed(`test.yml completed but did not succeed (conclusion=${run.conclusion}).`);
                  return;
                }
              } else {
                core.info("No test.yml run found yet for this SHA; waiting...");
              }

              await new Promise((resolve) => setTimeout(resolve, sleepMs));
            }

            core.setFailed("Timed out waiting for test.yml to complete successfully for this SHA.");

  build_native:
    needs: gate_test
    uses: ./.github/workflows/build-native.yml
    with:
      ref: ${{ github.sha }}

  publish:
    runs-on: ubuntu-latest
    needs: build_native
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download native artifacts (Darwin AMD64)
        uses: actions/download-artifact@v7
        with:
          name: native-darwin-amd64
          path: build/out/darwin-amd64

      - name: Download native artifacts (Darwin ARM64)
        uses: actions/download-artifact@v7
        with:
          name: native-darwin-arm64
          path: build/out/darwin-arm64

      - name: Download native artifacts (Linux AMD64)
        uses: actions/download-artifact@v7
        with:
          name: native-linux-amd64
          path: build/out/linux-amd64

      - name: Download native artifacts (Linux ARM64)
        uses: actions/download-artifact@v7
        with:
          name: native-linux-arm64
          path: build/out/linux-arm64

      - name: Download native artifacts (Windows AMD64)
        uses: actions/download-artifact@v7
        with:
          name: native-windows-amd64
          path: build/out/windows-amd64

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Resolve release version from tag
        id: ver
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Make gradlew executable
        working-directory: kotlin
        run: |
          chmod +x gradlew

      - name: Publish and release to Maven Central (Central Portal)
        id: publish
        working-directory: kotlin
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
        shell: bash
        run: |
          set -o pipefail
          if [ -z "${ORG_GRADLE_PROJECT_mavenCentralUsername:-}" ] || [ -z "${ORG_GRADLE_PROJECT_mavenCentralPassword:-}" ]; then
            echo "Missing Maven Central credentials. Configure repository secrets:"
            echo "  - OSSRH_USERNAME (or Central Portal token username)"
            echo "  - OSSRH_PASSWORD (or Central Portal token password)"
            exit 1
          fi
          if [ -z "${ORG_GRADLE_PROJECT_signingInMemoryKey:-}" ] || [ -z "${ORG_GRADLE_PROJECT_signingInMemoryKeyPassword:-}" ]; then
            echo "Missing signing key material. Configure repository secrets:"
            echo "  - SIGNING_KEY"
            echo "  - SIGNING_PASSWORD"
            exit 1
          fi
          ./gradlew --no-daemon --stacktrace -Pversion="${{ steps.ver.outputs.version }}" publishAndReleaseToMavenCentral 2>&1 | tee ../publish.log


